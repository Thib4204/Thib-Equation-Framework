name: Auto Zenodo Deploy â€” ThibEquation

on:
  # TRIGGER 1: Push automatique sur main
  push:
    branches:
      - main
    paths:
      - 'REGISTRE_MAITRE_DSN-01_v5.0_FINAL_CONSOLIDE.html'
      - '.zenodo.json'
      - 'RTGS_Manifest_ThibEquation_v5.0.json'
  
  # TRIGGER 2: CrÃ©ation de tags (releases manuelles)
  push:
    tags:
      - 'v*.*.*'
  
  # TRIGGER 3: DÃ©clenchement planifiÃ© quotidien (optionnel)
  schedule:
    - cron: '0 0 * * *'  # Tous les jours Ã  minuit UTC
  
  # TRIGGER 4: DÃ©clenchement manuel via interface GitHub
  workflow_dispatch:
    inputs:
      version_increment:
        description: 'Type de version (patch/minor/major)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  THIBEQUATION_SITE: 'https://thibequation.com'
  LOGO_URL: 'https://www.genspark.ai/api/files/s/ztTPlT9r'

jobs:
  auto-deploy-zenodo:
    runs-on: ubuntu-latest
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 1: Checkout du code
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 2: DÃ©terminer la version automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ·ï¸ Auto-generate version number
        id: version
        run: |
          # RÃ©cupÃ©rer le dernier tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v5.0.0")
          echo "Dernier tag: $LAST_TAG"
          
          # Extraire les numÃ©ros de version
          VERSION=${LAST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # IncrÃ©menter selon le type
          INCREMENT="${{ github.event.inputs.version_increment || 'patch' }}"
          
          if [ "$INCREMENT" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$INCREMENT" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Nouvelle version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 3: TÃ©lÃ©charger le logo ThibEquation automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ–¼ï¸ Download ThibEquation Logo
        run: |
          echo "ğŸ“¥ TÃ©lÃ©chargement du logo depuis ${{ env.LOGO_URL }}..."
          
          # Tentative 1: tÃ©lÃ©chargement direct
          curl -L -o ThibEquation_Logo.png "${{ env.LOGO_URL }}" || true
          
          # VÃ©rifier la taille
          if [ -f "ThibEquation_Logo.png" ]; then
            SIZE=$(stat -c%s ThibEquation_Logo.png)
            if [ "$SIZE" -lt 50000 ]; then
              echo "âš ï¸  Logo tÃ©lÃ©chargÃ© invalide ($SIZE bytes)"
              rm ThibEquation_Logo.png
              
              # Tentative 2: depuis thibequation.com
              echo "ğŸ“¥ Tentative depuis thibequation.com..."
              curl -L -o ThibEquation_Logo.png "${{ env.THIBEQUATION_SITE }}/logo.png" || true
            fi
          fi
          
          # VÃ©rification finale
          if [ -f "ThibEquation_Logo.png" ]; then
            SIZE=$(stat -c%s ThibEquation_Logo.png)
            if [ "$SIZE" -gt 50000 ]; then
              echo "âœ… Logo tÃ©lÃ©chargÃ©: $(numfmt --to=iec-i --suffix=B $SIZE)"
            else
              echo "âŒ Ã‰chec tÃ©lÃ©chargement logo"
              echo "   Le workflow continuera sans logo (Ã  corriger)"
            fi
          else
            echo "âš ï¸  Logo non disponible, crÃ©ation d'un placeholder..."
            # CrÃ©er un fichier placeholder pour Ã©viter l'erreur
            touch ThibEquation_Logo_PLACEHOLDER.txt
          fi
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 4: Validation automatique des fichiers
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Validate files automatically
        run: |
          echo "ğŸ” Validation automatique des fichiers..."
          
          ERRORS=0
          
          # VÃ©rifier REGISTRE_MAITRE
          if [ -f "REGISTRE_MAITRE_DSN-01_v5.0_FINAL_CONSOLIDE.html" ]; then
            SIZE=$(stat -c%s REGISTRE_MAITRE_DSN-01_v5.0_FINAL_CONSOLIDE.html)
            if [ "$SIZE" -gt 10000 ]; then
              echo "âœ… REGISTRE_MAITRE: $(numfmt --to=iec-i --suffix=B $SIZE)"
            else
              echo "âŒ REGISTRE_MAITRE trop petit: $SIZE bytes"
              ((ERRORS++))
            fi
          else
            echo "âŒ REGISTRE_MAITRE manquant"
            ((ERRORS++))
          fi
          
          # VÃ©rifier .zenodo.json
          if [ -f ".zenodo.json" ]; then
            echo "âœ… .zenodo.json prÃ©sent"
          else
            echo "âŒ .zenodo.json manquant"
            ((ERRORS++))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ $ERRORS erreur(s) dÃ©tectÃ©e(s)"
            exit 1
          fi
          
          echo "âœ… Tous les fichiers validÃ©s"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 5: CrÃ©er le bundle ZIP automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Create Zenodo bundle automatically
        run: |
          echo "ğŸ”„ CrÃ©ation du bundle ZIP automatique..."
          
          VERSION="${{ steps.version.outputs.version }}"
          
          # Liste des fichiers Ã  inclure
          FILES=(
            "REGISTRE_MAITRE_DSN-01_v5.0_FINAL_CONSOLIDE.html"
            ".zenodo.json"
            "README.md"
          )
          
          # Ajouter fichiers optionnels s'ils existent
          OPTIONAL_FILES=(
            "ThibEquation_Logo.png"
            "RTGS_Manifest_ThibEquation_v5.0.json"
            "ThibEquation_SYNTHESE_3_PRIORITES.md"
            "GUIDE_HORODATAGE_OPENTIMESTAMPS.md"
            "JWST_Proposal_Template_3I-ATLAS.md"
            "Resume_Executif_DSN-01_v5.0.md"
            "GITHUB_RELEASE_DESCRIPTION.md"
          )
          
          for file in "${OPTIONAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              FILES+=("$file")
              echo "  + $file"
            fi
          done
          
          # CrÃ©er le ZIP
          zip -r "ThibEquation_DSN-01_${VERSION}_BUNDLE.zip" "${FILES[@]}"
          
          BUNDLE_SIZE=$(stat -c%s "ThibEquation_DSN-01_${VERSION}_BUNDLE.zip")
          echo "âœ… Bundle crÃ©Ã©: $(numfmt --to=iec-i --suffix=B $BUNDLE_SIZE)"
          
          # Lister le contenu
          echo ""
          echo "ğŸ“‹ Contenu du bundle:"
          unzip -l "ThibEquation_DSN-01_${VERSION}_BUNDLE.zip"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 6: CrÃ©er tag Git automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ·ï¸ Create Git tag automatically
        id: create_tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # VÃ©rifier si le tag existe dÃ©jÃ 
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "â„¹ï¸  Tag $VERSION existe dÃ©jÃ , utilisation d'un timestamp"
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            VERSION="${VERSION}-${TIMESTAMP}"
          fi
          
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          
          # CrÃ©er le tag
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "ThibEquation Bot"
          
          git tag -a "$VERSION" -m "Auto-deploy: REGISTRE MAÃTRE DSN-01 $VERSION"
          git push origin "$VERSION"
          
          echo "âœ… Tag crÃ©Ã©: $VERSION"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 7: CrÃ©er GitHub Release automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸš€ Create GitHub Release automatically
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          name: "REGISTRE MAÃTRE DSN-01 ${{ steps.create_tag.outputs.tag }}"
          body: |
            ## ğŸ“¦ ThibEquation DSN-01 â€” DÃ©pÃ´t Automatique
            
            **Version**: ${{ steps.create_tag.outputs.tag }}  
            **Date**: ${{ github.event.head_commit.timestamp }}  
            **Commit**: ${{ github.sha }}
            
            ### ğŸ“„ Contenu
            - REGISTRE MAÃTRE DSN-01 v5.0 FINAL CONSOLIDÃ‰
            - MÃ©tadonnÃ©es Zenodo (.zenodo.json)
            - Manifest RTGS (hashes SHA-256)
            - Documentation complÃ¨te
            
            ### ğŸŒ Zenodo
            DOI permanent gÃ©nÃ©rÃ© automatiquement via API Zenodo.
            
            **Sans mensonge, Rigueur, Transparence.**
          files: |
            ThibEquation_DSN-01_${{ steps.create_tag.outputs.tag }}_BUNDLE.zip
            REGISTRE_MAITRE_DSN-01_v5.0_FINAL_CONSOLIDE.html
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 8: Upload vers Zenodo automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸŒ Auto-upload to Zenodo
        id: zenodo_upload
        run: |
          echo "ğŸš€ Upload automatique vers Zenodo..."
          
          # CrÃ©er dÃ©pÃ´t Zenodo
          RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ZENODO_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://zenodo.org/api/deposit/depositions)
          
          DEPOSITION_ID=$(echo $RESPONSE | jq -r '.id')
          BUCKET_URL=$(echo $RESPONSE | jq -r '.links.bucket')
          
          if [ "$DEPOSITION_ID" = "null" ]; then
            echo "âŒ Ã‰chec crÃ©ation dÃ©pÃ´t Zenodo"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "deposition_id=$DEPOSITION_ID" >> $GITHUB_OUTPUT
          echo "âœ… DÃ©pÃ´t Zenodo crÃ©Ã©: ID $DEPOSITION_ID"
          
          # Upload bundle
          VERSION="${{ steps.create_tag.outputs.tag }}"
          BUNDLE="ThibEquation_DSN-01_${VERSION}_BUNDLE.zip"
          
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.ZENODO_TOKEN }}" \
            --upload-file "$BUNDLE" \
            "$BUCKET_URL/$BUNDLE"
          
          echo "âœ… Bundle uploadÃ© vers Zenodo"
          
          # Mettre Ã  jour mÃ©tadonnÃ©es
          VERSION_NUMBER="${{ steps.version.outputs.version_number }}"
          METADATA=$(cat .zenodo.json | jq --arg ver "$VERSION_NUMBER" '.version = $ver')
          
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.ZENODO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$METADATA" \
            "https://zenodo.org/api/deposit/depositions/$DEPOSITION_ID"
          
          echo "âœ… MÃ©tadonnÃ©es mises Ã  jour"
          
          # Publier
          PUBLISH_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.ZENODO_TOKEN }}" \
            "https://zenodo.org/api/deposit/depositions/$DEPOSITION_ID/actions/publish")
          
          DOI=$(echo $PUBLISH_RESPONSE | jq -r '.doi')
          ZENODO_ID=$(echo $PUBLISH_RESPONSE | jq -r '.record_id')
          
          if [ "$DOI" = "null" ]; then
            echo "âŒ Ã‰chec publication Zenodo"
            echo "Response: $PUBLISH_RESPONSE"
            exit 1
          fi
          
          echo "doi=$DOI" >> $GITHUB_OUTPUT
          echo "zenodo_id=$ZENODO_ID" >> $GITHUB_OUTPUT
          
          echo "âœ… DOI gÃ©nÃ©rÃ©: $DOI"
          echo "âœ… Zenodo ID: $ZENODO_ID"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 9: Mettre Ã  jour README automatiquement
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”„ Auto-update README with DOI
        run: |
          DOI="${{ steps.zenodo_upload.outputs.doi }}"
          
          # Mettre Ã  jour le badge DOI
          sed -i "s|10\.5281/zenodo\.[0-9]*|$DOI|g" README.md
          
          # Commit et push
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "ThibEquation Bot"
          
          git add README.md
          git commit -m "ğŸ”– Auto-update: Zenodo DOI $DOI" || echo "Rien Ã  committer"
          git push || echo "Push Ã©chouÃ© (normal si rien Ã  committer)"
          
          echo "âœ… README mis Ã  jour avec DOI: $DOI"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ã‰TAPE 10: Notification de succÃ¨s
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ‰ Success notification
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DÃ‰PLOIEMENT AUTOMATIQUE ZENODO RÃ‰USSI"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Version: ${{ steps.create_tag.outputs.tag }}"
          echo "ğŸ”— GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.create_tag.outputs.tag }}"
          echo "ğŸŒ Zenodo Record: https://zenodo.org/record/${{ steps.zenodo_upload.outputs.zenodo_id }}"
          echo "ğŸ“ DOI permanent: ${{ steps.zenodo_upload.outputs.doi }}"
          echo ""
          echo "ğŸ¯ Workflow dÃ©clenchÃ© par: ${{ github.event_name }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "ğŸ“… Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "Sans mensonge, Rigueur, Transparence."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
